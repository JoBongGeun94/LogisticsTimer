import { useState } from 'react';
import { LapTime } from './types';
import { TimerDisplay } from './components/Timer/TimerDisplay';
import { TimerControls } from './components/Timer/TimerControls';
import { SessionManager } from './components/Session/SessionManager';
import { GageRRAnalysis } from './components/Analysis/GageRRAnalysis';
import { useTimer } from './hooks/useTimer';
import { useSession } from './hooks/useSession';
import { ExportService } from './services/ExportService';
import { Download, BarChart3 } from 'lucide-react';

function App() {
  const { currentTime, isRunning, start, stop, reset } = useTimer();
  const { sessions, currentSession, createSession, selectSession, addMeasurement } = useSession();
  
  const [selectedOperator, setSelectedOperator] = useState<string>('');
  const [selectedPart, setSelectedPart] = useState<string>('');
  const [measurements, setMeasurements] = useState<LapTime[]>([]);
  const [showAnalysis, setShowAnalysis] = useState(false);

  // 측정 완료 처리
  const handleLapTime = () => {
    if (!currentSession || !selectedOperator || !selectedPart) {
      alert('세션, 측정자, 대상자를 모두 선택해주세요.');
      return;
    }

    const lapTime: LapTime = {
      id: Date.now().toString(),
      time: currentTime,
      timestamp: new Date(),
      operatorId: selectedOperator,
      partId: selectedPart,
      sessionId: currentSession.id
    };

    addMeasurement(lapTime);
    setMeasurements(prev => [...prev, lapTime]);
    reset();
  };

  // CSV 다운로드
  const handleDownload = () => {
    if (measurements.length === 0) {
      alert('다운로드할 측정 데이터가 없습니다.');
      return;
    }

    ExportService.exportToCSV(measurements, currentSession?.name || 'measurements');
  };

  // MSA 요구사항 검증
  const canPerformAnalysis = () => {
    if (!currentSession || measurements.length < 10) return false;
    
    const operators = new Set(measurements.map(m => m.operatorId)).size;
    const parts = new Set(measurements.map(m => m.partId)).size;
    
    return operators >= 2 && parts >= 5;
  };

  return (
    <div className="min-h-screen bg-gray-100">
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <h1 className="text-2xl font-bold text-gray-900">
            물류 작업현장 Gage R&R 분석 시스템
          </h1>
          <p className="text-sm text-gray-600 mt-1">MSA 규격 완전 준수 · SOLID 원칙 적용</p>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* 좌측: 타이머 및 세션 관리 */}
          <div className="space-y-6">
            {/* 세션 관리 */}
            <SessionManager
              sessions={sessions}
              currentSession={currentSession}
              onCreateSession={createSession}
              onSelectSession={selectSession}
            />

            {/* 측정자/대상자 선택 */}
            {currentSession && (
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <h3 className="text-lg font-semibold mb-4">측정 설정</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      측정자 선택
                    </label>
                    <select
                      value={selectedOperator}
                      onChange={(e) => setSelectedOperator(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-md"
                    >
                      <option value="">선택하세요</option>
                      {currentSession.operators.map((operator) => (
                        <option key={operator} value={operator}>
                          {operator}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      대상자 선택
                    </label>
                    <select
                      value={selectedPart}
                      onChange={(e) => setSelectedPart(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-md"
                    >
                      <option value="">선택하세요</option>
                      {currentSession.parts.map((part) => (
                        <option key={part} value={part}>
                          {part}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
            )}

            {/* 타이머 */}
            <div className="bg-white p-8 rounded-lg shadow-lg">
              <TimerDisplay currentTime={currentTime} isRunning={isRunning} />
              <TimerControls
                isRunning={isRunning}
                onStart={start}
                onStop={stop}
                onReset={reset}
                onLap={handleLapTime}
                disabled={!currentSession || !selectedOperator || !selectedPart}
              />
            </div>

            {/* 측정 현황 */}
            {measurements.length > 0 && (
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">측정 현황</h3>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowAnalysis(!showAnalysis)}
                      disabled={!canPerformAnalysis()}
                      className={`px-4 py-2 rounded-md flex items-center gap-2 ${
                        canPerformAnalysis()
                          ? 'bg-green-500 hover:bg-green-600 text-white'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      <BarChart3 size={16} />
                      분석
                    </button>
                    <button
                      onClick={handleDownload}
                      className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center gap-2"
                    >
                      <Download size={16} />
                      CSV
                    </button>
                  </div>
                </div>
                
                <div className="grid grid-cols-3 gap-4 text-center">
                  <div className="bg-gray-50 p-3 rounded">
                    <div className="text-2xl font-bold text-blue-600">
                      {measurements.length}
                    </div>
                    <div className="text-sm text-gray-600">총 측정 수</div>
                  </div>
                  <div className="bg-gray-50 p-3 rounded">
                    <div className="text-2xl font-bold text-green-600">
                      {new Set(measurements.map(m => m.operatorId)).size}
                    </div>
                    <div className="text-sm text-gray-600">측정자 수</div>
                  </div>
                  <div className="bg-gray-50 p-3 rounded">
                    <div className="text-2xl font-bold text-purple-600">
                      {new Set(measurements.map(m => m.partId)).size}
                    </div>
                    <div className="text-sm text-gray-600">대상자 수</div>
                  </div>
                </div>

                {!canPerformAnalysis() && (
                  <div className="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded text-yellow-800 text-sm">
                    MSA 규격 분석을 위해서는 최소 10회 측정, 2명 이상의 측정자, 5개 이상의 대상자가 필요합니다.
                  </div>
                )}
              </div>
            )}
          </div>

          {/* 우측: 분석 결과 */}
          <div className="space-y-6">
            {showAnalysis && canPerformAnalysis() && (
              <GageRRAnalysis
                measurements={measurements}
                onAnalysisComplete={(result) => {
                  console.log('Analysis completed:', result);
                }}
              />
            )}

            {/* 최근 측정 목록 */}
            {measurements.length > 0 && (
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <h3 className="text-lg font-semibold mb-4">최근 측정 기록</h3>
                <div className="max-h-96 overflow-y-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left">시간</th>
                        <th className="px-3 py-2 text-left">측정자</th>
                        <th className="px-3 py-2 text-left">대상자</th>
                        <th className="px-3 py-2 text-left">측정값</th>
                      </tr>
                    </thead>
                    <tbody>
                      {measurements.slice(-20).reverse().map((measurement) => (
                        <tr key={measurement.id} className="border-t">
                          <td className="px-3 py-2">
                            {measurement.timestamp.toLocaleTimeString()}
                          </td>
                          <td className="px-3 py-2">{measurement.operatorId}</td>
                          <td className="px-3 py-2">{measurement.partId}</td>
                          <td className="px-3 py-2 font-mono">
                            {measurement.time.toFixed(3)}s
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

export default App;
